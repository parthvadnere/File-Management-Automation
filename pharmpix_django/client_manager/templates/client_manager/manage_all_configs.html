{% extends 'client_manager/base.html' %}

{% block content %}
<div class="config-management-container">
    <!-- <h2 class="page-title">Manage All Configurations</h2> -->
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Input Configurations Section -->
    <div class="config-section input-section">
        <div class="section-header">
            <h3><i class="fas fa-file-import"></i> File Configuration for SFTP to EFTP</h3>
            <button class="refresh-btn" data-section="input" title="Refresh Data">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <div class="section-content">
            <div class="table-container" id="input-table-container">
                <div class="loading-overlay hidden" id="input-loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>File Type</th>
                            <th>Remote Path</th>
                            <th class="pattern-col">File Pattern</th>
                            <th>Local Path</th>
                            <th>Renamed Pattern</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="input-table-body">
                        {% include 'client_manager/partials/input_table.html' %}
                    </tbody>
                </table>
                <!-- Pagination for Input Configurations -->
                <div class="pagination-container" id="input-pagination-container">
                    <div class="pagination" id="input-pagination">
                        {% include 'client_manager/partials/input_pagination.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Output Configurations Section -->
    <div class="config-section output-section">
        <div class="section-header">
            <h3><i class="fas fa-file-export"></i> File Configuration for EFTP to SFTP</h3>
            <button class="refresh-btn" data-section="output" title="Refresh Data">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <div class="section-content">
            <div class="table-container" id="output-table-container">
                <div class="loading-overlay hidden" id="output-loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Path</th>
                            <th>Task</th>
                            <th>File Type</th>
                            <th>Output Dir</th>
                            <th>Filename Template</th>
                        </tr>
                    </thead>
                    <tbody id="output-table-body">
                        {% include 'client_manager/partials/output_table.html' %}
                    </tbody>
                </table>
                <!-- Pagination for Output Configurations -->
                <div class="pagination-container" id="output-pagination-container">
                    <div class="pagination" id="output-pagination">
                        {% include 'client_manager/partials/output_pagination.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle AJAX pagination
    function loadPage(section, page) {
        const loadingElement = document.getElementById(section + '-loading');
        const url = '{% url "manage_all_configs" %}?section=' + section + '&page_' + section + '=' + page;
        
        // Show loading spinner
        loadingElement.classList.remove('hidden');
        
        // Create AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                // Hide loading spinner
                loadingElement.classList.add('hidden');
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Response for section ' + section + ':', response); // Debug log
                        
                        if (response.success) {
                            // Update table content
                            document.getElementById(section + '-table-body').innerHTML = response.table_html;
                            
                            // Update pagination
                            document.getElementById(section + '-pagination').innerHTML = response.pagination_html;
                            
                            // Re-bind pagination events
                            bindPaginationEvents();
                        } else {
                            console.error('Error in response:', response.error); // Debug log
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.error || 'Unknown error occurred'
                            });
                        }
                    } catch (e) {
                        console.error('Parse error:', e); // Debug log
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to parse response: ' + e.message
                        });
                    }
                } else {
                    console.error('HTTP error:', xhr.status); // Debug log
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load data: HTTP ' + xhr.status
                    });
                }
            }
        };
        
        xhr.send();
    }
    
    // Function to bind pagination events
    function bindPaginationEvents() {
        // Remove existing event listeners to prevent duplicates
        document.querySelectorAll('.pagination-link').forEach(function(link) {
            link.replaceWith(link.cloneNode(true));
        });
        
        document.querySelectorAll('.refresh-btn').forEach(function(btn) {
            btn.replaceWith(btn.cloneNode(true));
        });
        
        // Bind pagination link clicks
        document.querySelectorAll('.pagination-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                const page = this.dataset.page;
                console.log('Pagination click:', section, page); // Debug log
                loadPage(section, page);
            });
        });
        
        // Bind refresh button clicks
        document.querySelectorAll('.refresh-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                const activeLink = document.querySelector('#' + section + '-pagination .page-item.active .pagination-link');
                const currentPage = activeLink ? activeLink.dataset.page : 1;
                console.log('Refresh click:', section, currentPage); // Debug log
                loadPage(section, currentPage);
            });
        });
    }
    
    // Initial binding
    bindPaginationEvents();
});
</script>
{% endblock %}