<!-- client_manager/templates/client_manager/client_details.html -->
{% extends 'client_manager/base.html' %}

{% block content %}
    <h2>Client Details: {{ client.name }}</h2>
    <div class="details-card">
        <h3>Client Information</h3>
        <p><strong>Name:</strong> {{ client.name }}</p>
        <p><strong>Description:</strong> {{ client.description|default:"-" }}</p>
        <p><strong>SFTP Host:</strong> {{ client.sftp_host|default:"-" }}</p>
        <p><strong>SFTP Username:</strong> {{ client.sftp_username|default:"-" }}</p>
        <p><strong>SFTP Port:</strong> {{ client.sftp_port|default:"-" }}</p>
        <div class="action-buttons">
            <a href="{% url 'edit_client' client.id %}" class="btn btn-warning"><i class="fas fa-edit"></i> Edit Client</a>
            <a href="{% url 'delete_client' client.id %}" class="btn btn-danger delete-btn"><i class="fas fa-trash"></i> Delete Client</a>
            <a href="{% url 'manage_clients' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Clients</a>
        </div>
    </div>

    <div class="details-section">
        <h3>Paths</h3>
        <a href="{% url 'add_path' client.id %}" class="btn btn-primary"><i class="fas fa-plus"></i> Add Path</a>
        <div class="table-container">
            <table class="client-table">
                <thead>
                    <tr>
                        <th>Path</th>
                        <th>File Types</th>
                        <th>Max Files</th>
                        <th>File Pattern</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for path in paths %}
                        <tr>
                            <td>{{ path.path }}</td>
                            <td>{{ path.file_types }}</td>
                            <td>{{ path.max_files }}</td>
                            <td>{{ path.file_pattern|default:"-" }}</td>
                            <td>
                                <a href="{% url 'edit_path' client.id path.id %}" class="btn btn-warning"><i class="fas fa-edit"></i></a>
                                <a href="{% url 'delete_path' client.id path.id %}" class="btn btn-danger delete-btn"><i class="fas fa-trash"></i></a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5">No paths found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="details-section">
        <h3>Output Configurations</h3>
        <a href="{% url 'add_output_config' client.id %}" class="btn btn-primary"><i class="fas fa-plus"></i> Add Output Config</a>
        <div class="table-container">
            <table class="client-table">
                <thead>
                    <tr>
                        <th>Path</th>
                        <th>Task</th>
                        <th>File Type</th>
                        <th>Output Dir</th>
                        <th>Filename Template</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for config in output_configs %}
                        <tr>
                            <td>{{ config.path.path }}</td>
                            <td>{{ config.task.name }}</td>
                            <td>{{ config.file_type }}</td>
                            <td>{{ config.output_dir }}</td>
                            <td>{{ config.filename_template }}</td>
                            <td>
                                <a href="{% url 'edit_output_config' client.id config.id %}" class="btn btn-warning"><i class="fas fa-edit"></i></a>
                                <a href="{% url 'delete_output_config' client.id config.id %}" class="btn btn-danger delete-btn"><i class="fas fa-trash"></i></a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6">No output configurations found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="details-section">
        <h3>Downloaded Files</h3>
        <div class="date-filter">
            <label for="dateFilter">Select Date to Download:</label>
            <input type="date" id="dateFilter" name="dateFilter" value="{{ selected_date|date:'Y-m-d' }}">
            <button id="downloadFilesBtn" class="btn btn-primary" data-client-id="{{ client.id }}">Download Files</button>
        </div>
        <div class="table-container">
            <table class="client-table">
                <thead>
                    <tr>
                        <th><a href="?sort=filename">Filename</a></th>
                        <th><a href="?sort=file_type">File Type</a></th>
                        <th><a href="?sort=path">Path</a></th>
                        <th><a href="?sort=downloaded_at">Downloaded At</a></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in downloaded_files %}
                    <tr>
                        <td>{{ file.original_filename }}</td>
                        <td>{{ file.file_type }}</td>
                        <td>{{ file.path }}</td>
                        <td>{{ file.downloaded_at|date:"Y-m-d H:i:s" }}</td>
                        <td>
                            <button class="btn btn-info action-btn view-file-btn" data-file-id="{{ file.id }}" data-file-url="{% url 'view_file' file.id %}" data-errors="{{ file.validation_errors|default:''|escape }}" data-validated="{{ file.is_validated|yesno:'true,false' }}" data-sent="{{ file.sent_to_sftp|yesno:'true,false' }}" data-client-id="{{ client.id }}"><i class="fas fa-eye"></i></button>
                            <a href="{% url 'view_file' file.id %}" class="btn btn-secondary action-btn" download><i class="fas fa-download"></i></a>
                            <a href="{% url 'replace_file' file.id %}" class="btn btn-warning action-btn"><i class="fas fa-upload"></i></a>
                            <a href="{% url 'delete_file' file.id %}" class="btn btn-danger action-btn delete-btn"><i class="fas fa-trash"></i></a>
                            {% if file.sent_to_sftp %}
                                <span class="btn btn-success action-btn disabled"><i class="fas fa-check"></i></span>
                            {% elif file.is_validated %}
                                <button class="btn btn-primary action-btn send-sftp-btn" data-file-id="{{ file.id }}" data-client-id="{{ client.id }}"><i class="fas fa-upload"></i></button>
                            {% else %}
                                <button class="btn btn-danger action-btn view-errors-btn" data-errors="{{ file.validation_errors|escape }}"><i class="fas fa-exclamation-circle"></i></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5">No downloaded files found. <a href="{% url 'download_files' client.id %}" class="btn btn-primary btn-sm">Download Now</a></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Viewing Files -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h3>File Viewer</h3>
            <div id="fileFrame"></div>
            <div id="errorSection" class="hidden">
                <h4>Validation Errors for {{ downloaded_files.0.original_filename|default:'File' }}</h4>
                <pre id="errorContent"></pre>
            </div>
            <div class="modal-actions">
                <button id="modalSendSftpBtn" class="btn btn-primary" style="display: none;"><i class="fas fa-upload"></i></button>
                <a id="modalReplaceBtn" href="#" class="btn btn-warning" style="display: none;"><i class="fas fa-upload"></i></a>
            </div>
        </div>
    </div>
    
    <!-- Modal for Viewing Validation Errors (standalone) -->
    <div id="errorModal" class="error-modal">
        <div class="error-modal-content">
            <span class="close-error">×</span>
            <h3>Validation Errors</h3>
            <pre id="standaloneErrorContent"></pre>
            <p>Please replace or edit the file to correct these issues.</p>
        </div>
    </div>
    <script type="text/javascript">
        window.replaceUrlBase = "{% url 'replace_file' 0 %}";
        // Define the base URL template for download_files_with_date
        window.downloadUrlBase = "{% url 'download_files_with_date' client.id 'placeholder' %}";
    </script>
{% endblock %}