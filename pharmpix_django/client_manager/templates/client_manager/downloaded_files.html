{% extends 'client_manager/base.html' %}

{% block content %}
<div class="config-management-container">
    <!-- <h2 class="page-title">Downloaded Files</h2> -->
    <a href="{% url 'manage_clients' %}" class="btn btn-secondary">Back to Clients</a>

    <!-- Downloaded Files Section -->
    <div class="config-section output-section">
        <div class="section-header">
            <h3><i class="fas fa-file-download"></i> Downloaded Files</h3>
            <button class="refresh-btn" data-section="downloaded" title="Refresh Data">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <div class="section-content">
            <div class="table-container" id="downloaded-table-container">
                <div class="loading-overlay hidden" id="downloaded-loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Original Filename</th>
                            <th>File Type</th>
                            <th>Path</th>
                            <th>Validated</th>
                            <th>Errors</th>
                            <th>Downloaded At</th>
                        </tr>
                    </thead>
                    <tbody id="downloaded-table-body">
                        {% for file in downloaded_files %}
                        <tr>
                            <td>{{ file.client.name }}</td>
                            <td>{{ file.original_filename }}</td>
                            <td>{{ file.file_type }}</td>
                            <td>{{ file.path }}</td>
                            <td>{{ file.is_validated|yesno:"Yes,No" }}</td>
                            <td>{{ file.validation_errors|default:"None" }}</td>
                            <td>{{ file.downloaded_at }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7">No downloaded files found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- Pagination for Downloaded Files -->
                <div class="pagination-container" id="downloaded-pagination-container">
                    <div class="pagination" id="downloaded-pagination">
                        {% if downloaded_files.has_other_pages %}
                            <ul class="pagination pagination-inline justify-content-center mt-3">
                                {% if downloaded_files.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link pagination-link" href="#" data-section="downloaded" data-page="{{ downloaded_files.previous_page_number }}">Previous</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">Previous</span>
                                    </li>
                                {% endif %}
                                {% for num in downloaded_files.paginator.page_range %}
                                    <li class="page-item {% if downloaded_files.number == num %}active{% endif %}">
                                        <a class="page-link pagination-link" href="#" data-section="downloaded" data-page="{{ num }}">{{ num }}</a>
                                    </li>
                                {% endfor %}
                                {% if downloaded_files.has_next %}
                                    <li class="page-item">
                                        <a class="page-link pagination-link" href="#" data-section="downloaded" data-page="{{ downloaded_files.next_page_number }}">Next</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">Next</span>
                                    </li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle AJAX pagination
    function loadPage(section, page) {
        const loadingElement = document.getElementById(section + '-loading');
        const url = '{% url "downloaded_files" %}';
        
        // Show loading spinner
        loadingElement.classList.remove('hidden');
        
        // Create AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url + '?section=' + section + '&page_' + section + '=' + page, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                // Hide loading spinner
                loadingElement.classList.add('hidden');
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success) {
                            // Update table content
                            document.getElementById(section + '-table-body').innerHTML = response.table_html;
                            
                            // Update pagination
                            document.getElementById(section + '-pagination').innerHTML = response.pagination_html;
                            
                            // Re-bind pagination events for the updated content
                            bindPaginationEvents();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.error || 'Unknown error occurred'
                            });
                        }
                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to parse response'
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load data: HTTP ' + xhr.status
                    });
                }
            }
        };
        
        xhr.send();
    }
    
    // Function to bind pagination events
    function bindPaginationEvents() {
        // Remove any existing event listeners to prevent duplicates
        document.querySelectorAll('.pagination-link').forEach(function(link) {
            link.replaceWith(link.cloneNode(true));
        });
        
        document.querySelectorAll('.refresh-btn').forEach(function(btn) {
            btn.replaceWith(btn.cloneNode(true));
        });
        
        // Bind pagination link clicks
        document.querySelectorAll('.pagination-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                const page = this.dataset.page;
                loadPage(section, page);
            });
        });
        
        // Bind refresh button clicks
        document.querySelectorAll('.refresh-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                // Get current page number
                const activeLink = document.querySelector('#' + section + '-pagination .page-item.active .pagination-link');
                const currentPage = activeLink ? activeLink.dataset.page : 1;
                loadPage(section, currentPage);
            });
        });
    }
    
    // Initial binding
    bindPaginationEvents();
});
</script>
{% endblock %}